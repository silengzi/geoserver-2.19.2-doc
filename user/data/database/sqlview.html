<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <title>SQL Views &mdash; GeoServer 2.19.2 User Manual</title>
  <link rel="stylesheet" href="../../_static/blueprint/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="../../_static/blueprint/print.css" type="text/css" media="print" /> 
  <!--[if IE]>
  <link rel="stylesheet" href="../../_static/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->
  <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.19.2',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/searchtools.js"></script>
  <script type="text/javascript" src="../../searchindex.js"></script>
  <link rel="shortcut icon" href="../../_static/geoserver.ico"/>
      <link rel="search" title="Search" href="../../search.html" />
      <link rel="top" title="GeoServer 2.19.2 User Manual" href="../../index.html" />
      <link rel="up" title="Databases" href="index.html" />
      <link rel="next" title="Controlling feature ID generation in spatial databases" href="primarykey.html" />
      <link rel="prev" title="JNDI" href="jndi.html" />
</head>
<body class="data/database/sqlview">
  <div id="header" class="selfclear">
    <div class="wrap selfclear">
      <div id="logo"><a href="../../index.html">GeoServer 2.19.2 User Manual</a></div>
      <ul id="top-nav">
        <li class="first"><a href="http://geoserver.org/about">About</a></li>
        <li><a href="http://blog.geoserver.org/">Blog</a></li>
        <li><a href="http://geoserver.org/download">Download</a></li>
        <!--<li><a href="../../index.html">Documentation</a></li>-->
      </ul>
        <form id="quick-search" action="../../search.html" method="get">
          <fieldset>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" value="Search Documentation&hellip;" size="20" tabindex="3" onblur="if(this.value=='') this.value='Search Documentation&hellip;';" onfocus="if(this.value=='Search Documentation&hellip;') this.value='';" />
            <input id="quick-search-submit" type="image" value="Search" src="../../_static/chrome/search_icon_green.png" />
          </fieldset>
        </form>
    </div><!-- /.wrap -->
  </div><!-- /#header -->
  <div id="main">
    <div class="wrap selfclear">
      <div id="content-left" class="content-border"></div>
      <div id="content">
<ul id="breadcrumbs">
  
  <li><a href="../../index.html">GeoServer 2.19.2 User Manual</a> &raquo;</li>
  <li><a href="../index.html" accesskey="U">Data management</a> &raquo;</li>
  <li><a href="index.html" accesskey="U">Databases</a> &raquo;</li>
  <li>SQL Views</li>
</ul>
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="../../py-modindex.html" title="Python Module Index"
       accesskey="">modules</a></li>
  <li>
    <a href="primarykey.html" title="Controlling feature ID generation in spatial databases"
       accesskey="N">next</a>|</li>
  <li>
    <a href="jndi.html" title="JNDI"
       accesskey="P">previous</a>|</li>
</ul>
        
  <div class="section" id="sql-views">
<span id="id1"></span><h1>SQL Views<a class="headerlink" href="#sql-views" title="Permalink to this headline">¶</a></h1>
<p>The traditional way to access database data is to configure layers against either tables or database views.
Starting with GeoServer 2.1.0, layers can also be defined as SQL Views.
SQL Views allow executing a custom SQL query on each request to the layer.
This avoids the need to create a database view for complex queries.</p>
<p>Even more usefully, SQL View queries can be parameterized via string substitution.
Parameter values can be supplied in both WMS and WFS requests.
Default values can be supplied for parameters, and input values can be validated by Regular Expressions
to eliminate the risk of SQL injection attacks.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SQL Views are read-only, and thus cannot be updated by WFS-T transactions.</p>
</div>
<div class="section" id="creating-a-sql-view">
<h2>Creating a SQL View<a class="headerlink" href="#creating-a-sql-view" title="Permalink to this headline">¶</a></h2>
<p>In order to create a SQL View the administrator invokes the <span class="guilabel">Create new layer</span> page.
When a database store is selected, the usual list of tables and views available for publication appears,
A link <span class="guilabel">Configure new SQL view…</span> also appears:</p>
<div class="figure align-center">
<img alt="../../_images/createsqlview.png" src="../../_images/createsqlview.png" />
</div>
<p>Selecting the <span class="guilabel">Configure new SQL view…</span> link opens a new page where the SQL view query can be specified:</p>
<div class="figure align-center">
<img alt="../../_images/createsql.png" src="../../_images/createsql.png" />
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The query can be any SQL statement that is valid as a subquery in a FROM clause (that is, <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">(&lt;the</span> <span class="pre">sql</span> <span class="pre">view&gt;)</span> <span class="pre">[as]</span> <span class="pre">vtable</span></code>).
This is the case for most SQL statements, but in some databases special syntax may be needed to call stored procedures.
Also, all the columns returned by the SQL statement must have names.
In some databases alias names are required for function calls.</p>
</div>
<p>When a valid SQL query has been entered, press the <span class="guilabel">Refresh</span> link in the <strong>Attributes</strong> table to get the list of the attribute columns determined from the query:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-attributes.png" src="../../_images/sqlview-attributes.png" />
</div>
<p>GeoServer attempts to determine the geometry column type and the native SRID, but these should be verified and corrected if necessary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Having a correct SRID (spatial reference id) is essential for spatial queries to work.
In many spatial databases the SRID is equal to the EPSG code for the specific spatial reference system, but this is not always the case (for instance, Oracle has a number of non-EPSG SRID codes).</p>
</div>
<p>If stable feature ids are desired for the view’s features, one or more columns providing a unique id for the features should be checked in the <strong>Identifier</strong> column.
Always ensure these attributes generate a unique key, or filtering and WFS requests will not work correctly.</p>
<p>Once the query and the attribute details are defined, press <span class="guilabel">Save</span>.
The usual <span class="guilabel">New Layer</span> configuration page will appear.
If further changes to the view are required, the page has a link to the SQL View editor at the bottom of the <span class="guilabel">Data</span> tab:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-edit.png" src="../../_images/sqlview-edit.png" />
</div>
<p>Once created, the SQL view layer is used in the same way as a conventional table-backed layer,
with the one limitation of being read-only.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Saving the SQL view definition here is not sufficient, the layer containing it must be saved as well for the change to have any effect.
This is because the SQL view definition is actually just one component of the layer/featuretype/coverage attributes.</p>
</div>
</div>
<div class="section" id="parameterizing-sql-views">
<h2>Parameterizing SQL Views<a class="headerlink" href="#parameterizing-sql-views" title="Permalink to this headline">¶</a></h2>
<p>A parametric SQL view is based on a SQL query containing named parameters.
The values for the parameters can be provided dynamically in WMS and WFS requests
using the <code class="docutils literal notranslate"><span class="pre">viewparams</span></code> request parameter.
Parameters can have default values specified,
to handle the situation where they are not supplied in a request.
Validation of supplied parameter values is supported by specifying validation regular expressions.
Parameter values are only accepted if they match the regular expression defined for them.
Appropriate parameter validation should always be used to avoid the risk of <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection attacks</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>SQL View parameter substitution should be used with caution, since improperly validated parameters open the risk of SQL injection attack.
Where possible, consider using safer methods such as <a class="reference internal" href="../../filter/index.html#filtering"><span class="std std-ref">dynamic filtering</span></a> in the request, or <a class="reference internal" href="../../styling/sld/extensions/substitution.html#sld-variable-substitution"><span class="std std-ref">Variable substitution in SLD</span></a>.</p>
</div>
<div class="section" id="defining-parameters">
<h3>Defining parameters<a class="headerlink" href="#defining-parameters" title="Permalink to this headline">¶</a></h3>
<p>Within the SQL View query, parameter names are delimited by leading and trailing <code class="docutils literal notranslate"><span class="pre">%</span></code> signs.
The parameters can occur anywhere within the query text,
including such uses as within SQL string constants,
in place of SQL keywords, or representing entire SQL clauses.</p>
<p>Here is an example of a SQL View query for a layer called <code class="docutils literal notranslate"><span class="pre">popstates</span></code> with two parameters, <code class="docutils literal notranslate"><span class="pre">low</span></code> and <code class="docutils literal notranslate"><span class="pre">high</span></code>:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-parametricsql.png" src="../../_images/sqlview-parametricsql.png" />
</div>
<p>Each parameter needs to be defined with its name, an optional default value, and a validation expression.
The <span class="guilabel">Guess parameters from SQL</span> link can be clicked to infer the query parameters automatically, or they can be entered manually.
The result is a table filled with the parameter names, default values and validation expressions:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-paramdefault.png" src="../../_images/sqlview-paramdefault.png" />
</div>
<p>In this case the default values should be specified, since the query cannot be executed without values for the parameters (because the expanded query <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">gid,</span> <span class="pre">state_name,</span> <span class="pre">the_geom</span> <span class="pre">from</span> <span class="pre">pgstates</span> <span class="pre">where</span> <span class="pre">persons</span> <span class="pre">between</span> <span class="pre">and</span></code> is invalid SQL).
Since the use of the parameters in the SQL query requires their values to be positive integer numbers, the validation regular expressions are specified to allow only numeric input (i.e. <code class="docutils literal notranslate"><span class="pre">^[\d]+$</span></code>):</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-paramcustom.png" src="../../_images/sqlview-paramcustom.png" />
</div>
<p>Once the parameters have been defined,
the <strong>Attributes</strong> <span class="guilabel">Refresh</span> link is clicked to parse the query and retrieve the attribute columns.
The computed geometry type and column identifier details can be corrected if required.
From this point on the workflow is the same as for a non-parameterized query.</p>
</div>
<div class="section" id="using-a-parametric-sql-view">
<span id="id2"></span><h3>Using a parametric SQL View<a class="headerlink" href="#using-a-parametric-sql-view" title="Permalink to this headline">¶</a></h3>
<p>The SQL view parameters are specified by adding the <code class="docutils literal notranslate"><span class="pre">viewparams</span></code> parameter to the WMS <code class="docutils literal notranslate"><span class="pre">GetMap</span></code>
or the WFS <code class="docutils literal notranslate"><span class="pre">GetFeature</span></code> request.
The <code class="docutils literal notranslate"><span class="pre">viewparams</span></code> argument is a list of <code class="docutils literal notranslate"><span class="pre">key:value</span></code> pairs, separated by semicolons:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">viewparams=p1:v1;p2:v2;...</span></code></p>
</div></blockquote>
<p>If the values contain semicolons or commas these must be escaped with a backslash (e.g. <code class="docutils literal notranslate"><span class="pre">\,</span></code> and <code class="docutils literal notranslate"><span class="pre">\;</span></code>).</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">popstates</span></code> SQL View layer can be displayed by invoking the <a class="reference internal" href="../webadmin/layerpreview.html#layerpreview"><span class="std std-ref">Layer Preview</span></a>.
Initially no parameter values are supplied, so the defaults are used and all the states are displayed.</p>
<p>To display all states having more than 20 million inhabitants the following parameter is added to the <code class="docutils literal notranslate"><span class="pre">GetMap</span></code> request: <code class="docutils literal notranslate"><span class="pre">&amp;viewparams=low:20000000</span></code></p>
<div class="figure align-center">
<img alt="../../_images/sqlview-20millions.png" src="../../_images/sqlview-20millions.png" />
</div>
<p>To display all states having between 2 and 5 million inhabitants the view parameters are: <code class="docutils literal notranslate"><span class="pre">&amp;viewparams=low:2000000;high:5000000</span></code></p>
<div class="figure align-center">
<img alt="../../_images/sqlview-2m-5m.png" src="../../_images/sqlview-2m-5m.png" />
</div>
<p>Parameters can be provided for multiple layers by separating each parameter map with a comma:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">&amp;viewparams=l1p1:v1;l1p2:v2,l2p1:v1;l2p2:v2,...</span></code></p>
</div></blockquote>
<p>The number of parameter maps must match the number of layers (featuretypes) included in the request.</p>
</div>
<div class="section" id="parameters-and-validation">
<h3>Parameters and validation<a class="headerlink" href="#parameters-and-validation" title="Permalink to this headline">¶</a></h3>
<p>The value of a SQL View parameter can be an arbitrary string of text.
The only constraint is that the attribute names and types returned by the view query must never change.
This makes it possible to create views containing parameters representing complex SQL fragments.
For example, using the view query <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">pgstates</span> <span class="pre">%where%</span></code> allows specifying the WHERE clause of the query dynamically.
However, this would likely require an empty validation expression.
which presents a serious risk of <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection attacks</a>.
This technique should only be used if access to the server is restricted to trusted clients.</p>
<p>In general, SQL parameters must be used with care.
They should always include validation regular expressions that accept only the intended parameter values.
Note that while validation expressions should be constructed to prevent illegal values,
they do not necessarily have to ensure the values are syntactically correct,
since this will be checked by the database SQL parser.
For example:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">^[\d\.\+-eE]+$</span></code> checks that a parameter value contains valid characters for floating-point numbers (including scientific notation), but does not check that the value is actually a valid number</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[^;']+</span></code> checks that a parameter value does not contain quotes or semicolons.  This prevents common SQL injection attacks, but otherwise does not impose much limitation on the actual value</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="resources-for-validation-regular-expressions">
<h3>Resources for Validation Regular expressions<a class="headerlink" href="#resources-for-validation-regular-expressions" title="Permalink to this headline">¶</a></h3>
<p>Defining effective validation regular expressions is important for security.
Regular expressions are a complex topic that cannot be fully addressed here.
The following are some resources for constructing regular expressions:</p>
<blockquote>
<div><ul class="simple">
<li><p>GeoServer uses the standard Java regular expression engine. The <a class="reference external" href="http://java.sun.com/javase/6/docs/api/java/util/regex/Pattern.html">Pattern class Javadocs</a> contain the full specification of the allowed syntax.</p></li>
<li><p><a class="reference external" href="http://www.regular-expressions.info">http://www.regular-expressions.info</a> has many tutorials and examples of regular expressions.</p></li>
<li><p>The <a class="reference external" href="http://myregexp.com/">myregexp</a> applet can be used to test regular expressions online.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="place-holder-for-the-sql-where-clause">
<h3>Place holder for the SQL WHERE clause<a class="headerlink" href="#place-holder-for-the-sql-where-clause" title="Permalink to this headline">¶</a></h3>
<p>The SQL <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause produced by GeoServer using the context filters, e.g. the bounding box filter of a WMS query, will be added around the SQL view definition. This comes handy (better performance) when we have extra operations that can  be done on top of the rows filtered with the GeoServer produced filter first.</p>
<p>A typical use case for this functionality is the execution of analytic functions on top of the filtered results:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">STATION_NAME</span><span class="p">,</span>
       <span class="n">MEASUREMENT</span><span class="p">,</span>
       <span class="n">MEASUREMENT_TYPE</span><span class="p">,</span>
       <span class="k">LOCATION</span>
<span class="k">FROM</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">STATION_NAME</span><span class="p">,</span>
          <span class="n">MEASUREMENT</span><span class="p">,</span>
          <span class="n">MEASUREMENT_TYPE</span><span class="p">,</span>
          <span class="k">LOCATION</span><span class="p">,</span>
          <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">STATION_ID</span><span class="p">,</span> <span class="n">MEASUREMENT_TYPE</span>
                            <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">TIME</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">RANK</span>
   <span class="k">FROM</span>
     <span class="p">(</span><span class="k">SELECT</span> <span class="n">st</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">STATION_ID</span><span class="p">,</span>
             <span class="n">st</span><span class="p">.</span><span class="n">common_name</span> <span class="k">AS</span> <span class="n">STATION_NAME</span><span class="p">,</span>
             <span class="n">ob</span><span class="p">.</span><span class="n">value</span> <span class="k">AS</span> <span class="n">MEASUREMENT</span><span class="p">,</span>
             <span class="n">pr</span><span class="p">.</span><span class="n">param_name</span> <span class="k">AS</span> <span class="n">MEASUREMENT_TYPE</span><span class="p">,</span>
             <span class="n">ob</span><span class="p">.</span><span class="k">time</span> <span class="k">AS</span> <span class="k">TIME</span><span class="p">,</span>
             <span class="n">st</span><span class="p">.</span><span class="k">position</span> <span class="k">AS</span> <span class="k">LOCATION</span>
      <span class="k">FROM</span> <span class="n">meteo</span><span class="p">.</span><span class="n">meteo_stations</span> <span class="n">st</span>
      <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">meteo</span><span class="p">.</span><span class="n">meteo_observations</span> <span class="n">ob</span> <span class="k">ON</span> <span class="n">st</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ob</span><span class="p">.</span><span class="n">station_id</span>
      <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">meteo</span><span class="p">.</span><span class="n">meteo_parameters</span> <span class="n">pr</span> <span class="k">ON</span> <span class="n">ob</span><span class="p">.</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="n">pr</span><span class="p">.</span><span class="n">id</span>

      <span class="c1">-- SQL WHERE clause place holder for GeoServer</span>
      <span class="k">WHERE</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">:</span><span class="n">where_clause</span><span class="p">:)</span> <span class="k">AS</span> <span class="n">stations_filtered</span><span class="p">)</span> <span class="k">AS</span> <span class="n">stations</span>

<span class="k">WHERE</span> <span class="n">RANK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>A few restrictions apply when using the explicit <code class="docutils literal notranslate"><span class="pre">:where_clause:</span></code> place holder:</p>
<blockquote>
<div><ul class="simple">
<li><p>it needs to be added in a position where all the attributes known by GeoServer are already present</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">:where_clause:</span></code> can only appear once</p></li>
</ul>
</div></blockquote>
<p>When a <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause place holder is present, GeoServer will always add an explicit <code class="docutils literal notranslate"><span class="pre">AND</span></code> at the beginning of the produced <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause. This allows the injection of the produced <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> in the middle of complex expressions if needed.</p>
</div>
</div>
</div>


      <div class="selfclear pagination-nav">
          <div class="leftwise"><strong>Previous</strong>: <a href="jndi.html" title="previous chapter">JNDI</a></div>
          <div class="rightwise"><strong>Next</strong>: <a href="primarykey.html" title="next chapter">Controlling feature ID generation in spatial databases</a></div>
      </div>
      </div><!-- /#content> -->
      <div id="content-right" class="content-border"></div>
  <div id="sidebar" class="contrast">
      <div id="toc" class="section">
        <h3 class="pngfix">Table Of Contents</h3>
        <ul>
<li><a class="reference internal" href="#">SQL Views</a><ul>
<li><a class="reference internal" href="#creating-a-sql-view">Creating a SQL View</a></li>
<li><a class="reference internal" href="#parameterizing-sql-views">Parameterizing SQL Views</a><ul>
<li><a class="reference internal" href="#defining-parameters">Defining parameters</a></li>
<li><a class="reference internal" href="#using-a-parametric-sql-view">Using a parametric SQL View</a></li>
<li><a class="reference internal" href="#parameters-and-validation">Parameters and validation</a></li>
<li><a class="reference internal" href="#resources-for-validation-regular-expressions">Resources for Validation Regular expressions</a></li>
<li><a class="reference internal" href="#place-holder-for-the-sql-where-clause">Place holder for the SQL WHERE clause</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section">
          <h3>Continue Reading</h3>
          <ul>
            <li>Previous: <a href="jndi.html" title="previous chapter">JNDI</a></li>
            <li>Next: <a href="primarykey.html" title="next chapter">Controlling feature ID generation in spatial databases</a></li>
          </ul>
        </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
                
        <li><a href="https://github.com/geoserver/geoserver/tree/master/doc/en/user/source/data/database/sqlview.rst">Edit</a></li>
        </ul>
        </div>
  </div><!-- /#sidebar -->
  </div><!-- /.wrap> -->
</div><!-- /#main -->
<div id="footer">
  <div class="wrap">
    &copy; Copyright 2021, Open Source Geospatial Foundation. License <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution</a>.
    Last updated on Jul 20, 2021.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div><!-- /.wrap> -->
</div><!-- /#footer -->
  </body>
</html>