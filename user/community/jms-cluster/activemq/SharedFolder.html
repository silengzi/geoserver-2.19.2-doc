<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <title>Shared File System Primary/Replica &mdash; GeoServer 2.19.2 User Manual</title>
  <link rel="stylesheet" href="../../../static/blueprint/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="../../../static/blueprint/print.css" type="text/css" media="print" /> 
  <!--[if IE]>
  <link rel="stylesheet" href="../../../static/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->
  <link rel="stylesheet" href="../../../static/default.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.19.2',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
  <script type="text/javascript" src="../../../static/jquery.js"></script>
  <script type="text/javascript" src="../../../static/doctools.js"></script>
  <script type="text/javascript" src="../../../static/searchtools.js"></script>
  <script type="text/javascript" src="../../../searchindex.js"></script>
  <link rel="shortcut icon" href="../../../static/geoserver.ico"/>
      <link rel="search" title="Search" href="../../../search.html" />
      <link rel="top" title="GeoServer 2.19.2 User Manual" href="../../../index.html" />
      <link rel="up" title="JMS based Clustering" href="../index.html" />
      <link rel="next" title="SOLR data store" href="../../solr/index.html" />
      <link rel="prev" title="JDBC Primary/Replica" href="JDBC.html" />
</head>
<body class="community/jms-cluster/activemq/SharedFolder">
  <div id="header" class="selfclear">
    <div class="wrap selfclear">
      <div id="logo"><a href="../../../index.html">GeoServer 2.19.2 User Manual</a></div>
      <ul id="top-nav">
        <li class="first"><a href="http://geoserver.org/about">About</a></li>
        <li><a href="http://blog.geoserver.org/">Blog</a></li>
        <li><a href="http://geoserver.org/download">Download</a></li>
        <!--<li><a href="../../../index.html">Documentation</a></li>-->
      </ul>
        <form id="quick-search" action="../../../search.html" method="get">
          <fieldset>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" value="Search Documentation&hellip;" size="20" tabindex="3" onblur="if(this.value=='') this.value='Search Documentation&hellip;';" onfocus="if(this.value=='Search Documentation&hellip;') this.value='';" />
            <input id="quick-search-submit" type="image" value="Search" src="../../../static/chrome/search_icon_green.png" />
          </fieldset>
        </form>
    </div><!-- /.wrap -->
  </div><!-- /#header -->
  <div id="main">
    <div class="wrap selfclear">
      <div id="content-left" class="content-border"></div>
      <div id="content">
<ul id="breadcrumbs">
  
  <li><a href="../../../index.html">GeoServer 2.19.2 User Manual</a> &raquo;</li>
  <li><a href="../../index.html" accesskey="U">Community modules</a> &raquo;</li>
  <li><a href="../index.html" accesskey="U">JMS based Clustering</a> &raquo;</li>
  <li>Shared File System Primary/Replica</li>
</ul>
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="../../../py-modindex.html" title="Python Module Index"
       accesskey="">modules</a></li>
  <li>
    <a href="../../solr/index.html" title="SOLR data store"
       accesskey="N">next</a>|</li>
  <li>
    <a href="JDBC.html" title="JDBC Primary/Replica"
       accesskey="P">previous</a>|</li>
</ul>
        
  <div class="section" id="shared-file-system-primary-replica">
<h1>Shared File System Primary/Replica<a class="headerlink" href="#shared-file-system-primary-replica" title="Permalink to this headline">¶</a></h1>
<p>Basically you can run as many brokers as you wish from the same shared file system directory.
The first broker to grab the exclusive lock on the file is the primary broker.
If that broker dies and releases the lock then another broker takes over.
The replica brokers sit in a loop trying to grab the lock from the primary broker.
The following example shows how to configure a broker for Shared File System Primary/Replica where /sharedFileSystem is some directory on a shared file system.
It is just a case of configuring a file based store to use a shared directory.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;persistenceAdapter&gt;</span>
  <span class="nt">&lt;kahaDB</span> <span class="na">directory=</span><span class="s">&quot;/sharedFileSystem/sharedBrokerData&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/persistenceAdapter&gt;</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;persistenceAdapter&gt;</span>
  <span class="nt">&lt;levelDB</span> <span class="na">directory=</span><span class="s">&quot;/sharedFileSystem/sharedBrokerData&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/persistenceAdapter&gt;</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;persistenceAdapter&gt;</span>
  <span class="nt">&lt;amqPersistenceAdapter</span> <span class="na">directory=</span><span class="s">&quot;/sharedFileSystem/sharedBrokerData&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/persistenceAdapter&gt;</span>
</pre></div>
</div>
<div class="section" id="startup">
<h2>Startup<a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h2>
<p>On startup one primary grabs an exclusive lock on the broker file directory - all other brokers are replicas and pause waiting for the exclusive lock.</p>
<div class="figure align-center">
<img alt="../../../images/Startup.png" src="../../../images/Startup.png" />
</div>
<p>Clients should be using the Failover Transport to connect to the available brokers. e.g. using a URL something like the following</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span>failover:(tcp://broker1:61616,tcp://broker2:61616,tcp://broker3:61616)
</pre></div>
</div>
<p>Only the primary broker starts up its transport connectors and so the clients can only connect to the primary.</p>
</div>
<div class="section" id="primary-failure">
<h2>Primary failure<a class="headerlink" href="#primary-failure" title="Permalink to this headline">¶</a></h2>
<p>If the primary looses the exclusive lock then it immediately shuts down. If a primary shuts down or fails, one of the other replicas will grab the lock and so the topology switches to the following diagram</p>
<div class="figure align-center">
<img alt="../../../images/MasterFailed.png" src="../../../images/MasterFailed.png" />
</div>
<p>One of the other other replicas immediately grabs the exclusive lock on the file system to them commences becoming the primary, starting all of its transport connectors.
Clients lose connection to the stopped primary and then the failover transport tries to connect to the available brokers - of which the only one available is the new primary.</p>
</div>
<div class="section" id="primary-restart">
<h2>Primary restart<a class="headerlink" href="#primary-restart" title="Permalink to this headline">¶</a></h2>
<p>At any time you can restart other brokers which join the cluster and start as replicas waiting to become a primary if the primary is shutdown or a failure occurs.
So the following topology is created after a restart of an old primary…</p>
<div class="figure align-center">
<img alt="../../../images/MasterRestarted.png" src="../../../images/MasterRestarted.png" />
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have a SAN or shared file system it can be used to provide high availability such that if a broker is killed, another broker can take over immediately.</p>
<blockquote>
<div><p>Ensure your shared file locks work</p>
</div></blockquote>
<p>Note that the requirements of this failover system are a distributed file system like a SAN for which exclusive file locks work reliably. If you do not have such a thing available then consider using Primary/Replica instead which implements something similar but working on commodity hardware using local file systems which ActiveMQ does the replication.</p>
<blockquote>
<div><p>OCFS2 Warning</p>
</div></blockquote>
<p>Was testing using OCFS2 and both brokers thought they had the primary lock - this is because “OCFS2 only supports locking with ‘fcntl’ and not ‘lockf and flock’, therefore mutex file locking from Java isn’t supported.”</p>
<p>From <a class="reference external" href="http://sources.redhat.com/cluster/faq.html#gfs_vs_ocfs2">http://sources.redhat.com/cluster/faq.html#gfs_vs_ocfs2</a> :</p>
<p>OCFS2: No cluster-aware flock or POSIX locks</p>
<p>GFS: fully supports Cluster-wide flocks and POSIX locks and is supported.</p>
<blockquote>
<div><p>NFSv3 Warning</p>
</div></blockquote>
<p>In the event of an abnormal NFSv3 client termination (i.e., the ActiveMQ primary broker), the NFSv3 server will not timeout the lock that is held by that client. This effectively renders the ActiveMQ data directory inaccessible because the ActiveMQ replica broker can’t acquire the lock and therefore cannot start up. The only solution to this predicament with NFSv3 is to reboot all ActiveMQ instances to reset everything.</p>
<p>Use of NFSv4 is another solution because it’s design includes timeouts for locks. When using NFSv4 and the client holding the lock experiences an abnormal termination, by design, the lock is released after 30 seconds, allowing another client to grab the lock. For more information about this, see this blog entry.</p>
</div>
</div>
</div>


      <div class="selfclear pagination-nav">
          <div class="leftwise"><strong>Previous</strong>: <a href="JDBC.html" title="previous chapter">JDBC Primary/Replica</a></div>
          <div class="rightwise"><strong>Next</strong>: <a href="../../solr/index.html" title="next chapter">SOLR data store</a></div>
      </div>
      </div><!-- /#content> -->
      <div id="content-right" class="content-border"></div>
  <div id="sidebar" class="contrast">
      <div id="toc" class="section">
        <h3 class="pngfix">Table Of Contents</h3>
        <ul>
<li><a class="reference internal" href="#">Shared File System Primary/Replica</a><ul>
<li><a class="reference internal" href="#startup">Startup</a></li>
<li><a class="reference internal" href="#primary-failure">Primary failure</a></li>
<li><a class="reference internal" href="#primary-restart">Primary restart</a></li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section">
          <h3>Continue Reading</h3>
          <ul>
            <li>Previous: <a href="JDBC.html" title="previous chapter">JDBC Primary/Replica</a></li>
            <li>Next: <a href="../../solr/index.html" title="next chapter">SOLR data store</a></li>
          </ul>
        </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
                
        <li><a href="https://github.com/geoserver/geoserver/tree/master/doc/en/user/source/community/jms-cluster/activemq/SharedFolder.rst">Edit</a></li>
        </ul>
        </div>
  </div><!-- /#sidebar -->
  </div><!-- /.wrap> -->
</div><!-- /#main -->
<div id="footer">
  <div class="wrap">
    &copy; Copyright 2021, Open Source Geospatial Foundation. License <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution</a>.
    Last updated on Jul 20, 2021.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div><!-- /.wrap> -->
</div><!-- /#footer -->
  </body>
</html>